name: Perpetual Dual Stream

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-session]

concurrency:
  group: streaming-group
  cancel-in-progress: true  # ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø¬Ø¯ÙŠØ¯

jobs:
  stream:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§¹ Delete Old Logs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1

      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable > /dev/null
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          pactl load-module module-null-sink sink_name=Sink1
          pactl load-module module-null-sink sink_name=Sink2

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os, subprocess, time, requests
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from multiprocessing import Process

          SWITCH_INTERVAL = 35 
          URL1_CONTROL = "https://meja.do.am/asd/url1.txt"
          URL2_CONTROL = "https://meja.do.am/asd/url2.txt"
          APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwybUCY_k-nPM4NQ2_ejdPKIKD_PfOk3nlAuwB7Ysfg8N0PHggTgvH8u2XJI_dtir0P/exec"
          # Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£Ùˆ Ø§Ù„ØªÙˆÙ‚Ù
          FALLBACK_VIDEO = "https://archive.org/download/mrtroll-stream-ended-2026-v1/MrTroll_Stream_Video.mp4"

          def get_url_from_file(control_url):
              try:
                  res = requests.get(f"{control_url}?t={int(time.time())}", timeout=5)
                  lines = [l.strip() for l in res.text.strip().split('\n') if l.strip()]
                  for line in lines:
                      parts = line.split()
                      # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… 1 Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø¥Ø°Ø§ 0 Ø³ÙŠØ¹ÙˆØ¯ None
                      if len(parts) >= 2 and parts[1] == "1":
                          return parts[0]
              except: pass
              return None

          # Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø°ÙƒÙŠØ©: ØªÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ØªØ®ÙÙŠ Ø§Ù„Ù…Ø§ÙˆØ³ØŒ ÙˆØªÙ†Ù‚Ø±
          def monitor_and_wait(driver, duration, control_url, current_url):
              start_time = time.time()
              check_interval = 5 # ÙØ­Øµ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
              
              while time.time() - start_time < duration:
                  try:
                      # 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø§ÙˆØ³ (Ø­Ù‚Ù† JS Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø®ØªÙØ§Ø¡)
                      driver.execute_script("document.body.style.cursor = 'none';")
                      
                      # 2. Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·
                      driver.find_element(By.TAG_NAME, 'body').click()
                  except: pass
                  
                  # 3. Ø§Ù„ÙØ­Øµ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†ØµÙŠ
                  checked_url = get_url_from_file(control_url)
                  
                  # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªÙˆÙ‚Ù ÙˆØ¬Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯ -> ÙƒØ³Ø± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„ØªØ­Ø¯ÙŠØ«
                  if current_url == FALLBACK_VIDEO and checked_url is not None:
                      return True 
                  # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø±Ø§Ø¨Ø· Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆØ§Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ (Ø£Ùˆ ØµØ§Ø± 0/None) -> ÙƒØ³Ø± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                  if current_url != FALLBACK_VIDEO and checked_url != current_url:
                      return True

                  time.sleep(check_interval)
              
              return False # Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±Ø§Øª

          def start_stream(rtmp_key, sink_name, control_url, initial_delay=0):
              if initial_delay > 0:
                  time.sleep(initial_delay)
              
              width, height = 720, 1280
              os.environ['PULSE_SINK'] = sink_name
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              
              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--kiosk')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--disable-dev-shm-usage')
              # Ø¥Ø®ÙØ§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
              opts.add_argument("--disable-notifications")
              opts.add_argument("--disable-infobars")
              
              driver = webdriver.Chrome(options=opts)
              ffmpeg_proc = None
              
              # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ù„Ø¨Ø« Ù…Ø³ØªÙ…Ø±ØŒ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØªØºÙŠØ±)
              ffmpeg_cmd = [
                  'ffmpeg', '-y', 
                  '-f', 'x11grab', '-s', f'{width}x{height}', '-i', f":{disp.display}",
                  '-f', 'pulse', '-i', f"{sink_name}.monitor",
                  '-c:v', 'libx264', 
                  '-preset', 'ultrafast', 
                  '-b:v', '3000k', 
                  '-maxrate', '3000k', 
                  '-bufsize', '6000k',
                  '-g', '60',
                  '-keyint_min', '60', 
                  '-sc_threshold', '0',
                  '-pix_fmt', 'yuv420p',
                  '-c:a', 'aac', '-b:a', '128k',
                  '-f', 'flv', f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
              ]
              
              try:
                  ffmpeg_proc = subprocess.Popen(ffmpeg_cmd)
                  
                  # Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙˆÙ† Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø«
                  while True:
                      target_url = get_url_from_file(control_url)
                      
                      # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·: Ø¥Ù…Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø· Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªÙˆÙ‚Ù
                      if target_url:
                          final_url = target_url
                      else:
                          final_url = FALLBACK_VIDEO
                      
                      try:
                          driver.get(final_url)
                          time.sleep(5) # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„
                      except: pass

                      # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
                      # Ø¥Ø°Ø§ Ø¹Ø§Ø¯Øª Ø§Ù„Ø¯Ø§Ù„Ø© True ÙŠØ¹Ù†ÙŠ Ø­Ø¯Ø« ØªØºÙŠÙŠØ± ÙˆÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙˆØ±Ø§Ù‹
                      # Ø¥Ø°Ø§ Ø¹Ø§Ø¯Øª False ÙŠØ¹Ù†ÙŠ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ (35 Ø¯Ù‚ÙŠÙ‚Ø©) ÙˆÙ†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹
                      monitor_and_wait(driver, SWITCH_INTERVAL * 60, control_url, final_url)
                      
              finally:
                  if ffmpeg_proc: ffmpeg_proc.terminate()
                  driver.quit()
                  disp.stop()

          if __name__ == "__main__":
              try: requests.get(APPS_SCRIPT_URL, timeout=10)
              except: pass

              R1, R2 = os.environ.get('R1'), os.environ.get('R2')
              # ØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­ÙƒÙ… Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
              p1 = Process(target=start_stream, args=(R1, "Sink1", URL1_CONTROL, 0))
              p2 = Process(target=start_stream, args=(R2, "Sink2", URL2_CONTROL, 60))
              
              p1.start()
              p2.start()
              p1.join()
              p2.join()
          EOF

      - name: Run Streaming Script
        env:
          R1: ${{ secrets.R1 }}
          R2: ${{ secrets.R2 }}
        run: python main.py

      - name: Wait & Restart
        # Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Cancelled)
        if: always() && !cancelled()
        run: |
          echo "â³ ÙØªØ±Ø© Ø±Ø§Ø­Ø©..."
          sleep 300
          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart-session"}'
