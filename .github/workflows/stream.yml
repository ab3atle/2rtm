name: Perpetual Dual Stream

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-session]

jobs:
  stream:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      
    steps:
      - uses: actions/checkout@v4

      # ---------------------------------------------------------
      # üëá Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã üëá
      # ---------------------------------------------------------
      - name: üßπ Delete Old Logs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0     # ÿßÿ≠ÿ∞ŸÅ ÿ£Ÿä ÿ¥Ÿäÿ° ÿ£ŸÇÿØŸÖ ŸÖŸÜ 0 ŸäŸàŸÖ (ÿ£Ÿä ÿßÿ≠ÿ∞ŸÅ ŸÅŸàÿ±ÿßŸã)
          keep_minimum_runs: 2 # ŸàŸÑŸÉŸÜ ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®ÿ¢ÿÆÿ± 2 ÿ≥ÿ¨ŸÑ ŸÅŸÇÿ∑ (ÿßŸÑÿ≠ÿßŸÑŸä ŸàÿßŸÑÿ≥ÿßÿ®ŸÇ) ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿπŸÖŸÑ

      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable > /dev/null
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          pactl load-module module-null-sink sink_name=Sink1
          pactl load-module module-null-sink sink_name=Sink2
          pacmd "update-sink-proplist Sink1 device.description=Stream1"
          pacmd "update-sink-proplist Sink2 device.description=Stream2"

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os, subprocess, time, requests
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from multiprocessing import Process

          # --- ÿßŸÑŸÖÿØÿ©: 5 ÿØŸÇÿßÿ¶ŸÇ ÿ™ÿ¥ÿ∫ŸäŸÑ ---
          RUN_MINUTES = 5 
          CONTROL_URL = "https://meja.do.am/asd/url2.txt"

          def get_driver_options(width, height):
              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--disable-dev-shm-usage')
              opts.add_argument('--disable-gpu')
              opts.add_argument(f'--window-size={width},{height}')
              opts.add_argument('--window-position=0,0')
              opts.add_argument('--kiosk')
              opts.add_argument('--force-device-scale-factor=1')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--incognito')
              opts.add_argument('--disable-cache')
              opts.add_argument('--disable-blink-features=AutomationControlled')
              opts.add_experimental_option("excludeSwitches", ["enable-automation"])
              opts.add_experimental_option('useAutomationExtension', False)
              return opts

          def start_stream(stream_id, rtmp_key, sink_name, width=720, height=1280):
              print(f"üü¢ ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ®ÿ´ {stream_id} ÿπŸÑŸâ ÿßŸÑŸÇŸÜÿßÿ© {sink_name}")
              os.environ['PULSE_SINK'] = sink_name
              env_vars = os.environ.copy()
              env_vars['PULSE_LATENCY_MSEC'] = '20'

              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              env_vars['DISPLAY'] = f":{disp.display}"

              try:
                  response = requests.get(f"{CONTROL_URL}?t={int(time.time())}", timeout=10)
                  lines = [line.strip() for line in response.text.strip().split('\n') if line.strip()]
                  if len(lines) < stream_id: return

                  config = lines[stream_id-1].split()
                  if config[1] == "1":
                      driver = webdriver.Chrome(options=get_driver_options(width, height))
                      driver.get(config[0])
                      time.sleep(10)

                      driver.execute_script("""
                          var style = document.createElement('style');
                          style.innerHTML = 'body { background: black !important; overflow: hidden !important; } ::-webkit-scrollbar { display: none; }';
                          document.head.appendChild(style);
                          if(!window.moveInterval){
                              window.moveInterval = setInterval(() => { window.scrollBy(0,1); window.scrollBy(0,-1); }, 50);
                          }
                      """)

                      ffmpeg_cmd = [
                          'ffmpeg', '-y', '-thread_queue_size', '4096',
                          '-f', 'x11grab', '-draw_mouse', '0', '-framerate', '30',
                          '-video_size', f'{width}x{height}', '-i', f":{disp.display}",
                          '-f', 'pulse', '-thread_queue_size', '4096', '-i', f"{sink_name}.monitor",
                          '-c:v', 'libx264', '-preset', 'ultrafast', '-tune', 'zerolatency',
                          '-b:v', '3500k', '-maxrate', '3500k', '-bufsize', '7000k',
                          '-pix_fmt', 'yuv420p', '-g', '60',
                          '-c:a', 'aac', '-b:a', '128k', '-ar', '44100',
                          '-af', 'aresample=async=1', '-vsync', '1',
                          '-f', 'flv', f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
                      ]
                      proc = subprocess.Popen(ffmpeg_cmd, env=env_vars)
                      time.sleep(RUN_MINUTES * 60)
                      proc.terminate()
                      driver.quit()
              finally:
                  disp.stop()

          if __name__ == "__main__":
              R1, R2 = os.environ.get('R1'), os.environ.get('R2')
              if R1 and R2:
                  p1 = Process(target=start_stream, args=(1, R1, "Sink1"))
                  p2 = Process(target=start_stream, args=(2, R2, "Sink2"))
                  p1.start(); p2.start()
                  p1.join(); p2.join()
                  print("‚úÖ ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖŸáŸÖÿ©.")
          EOF

      - name: Run Streaming Script
        env:
          R1: ${{ secrets.R1 }}
          R2: ${{ secrets.R2 }}
        run: python main.py

      - name: Wait & Restart
        if: always()
        run: |
          echo "‚è≥ ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© ÿØŸÇŸäŸÇÿ© Ÿàÿßÿ≠ÿØÿ©..."
          sleep 60
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart-session"}'
