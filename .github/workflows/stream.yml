name: Perpetual Dual Stream

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-session]

concurrency:
  group: streaming-group
  cancel-in-progress: true 

jobs:
  stream:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: üßπ Delete Old Logs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1

      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable > /dev/null
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          pactl load-module module-null-sink sink_name=Sink1
          pactl load-module module-null-sink sink_name=Sink2

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os, subprocess, time, requests
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from multiprocessing import Process

          # ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ´ÿßÿ®ÿ™ÿ©
          SWITCH_INTERVAL = 35 * 60 # 35 ÿØŸÇŸäŸÇÿ© ÿ®ÿßŸÑÿ´ŸàÿßŸÜŸä
          URL1_CONTROL = "https://meja.do.am/asd/url1.txt"
          URL2_CONTROL = "https://meja.do.am/asd/url2.txt"
          FALLBACK_VIDEO = "https://archive.org/download/mrtroll-stream-ended-2026-v1/MrTroll_Stream_Video.mp4"

          def get_active_url(control_url):
              try:
                  res = requests.get(f"{control_url}?t={int(time.time())}", timeout=5)
                  lines = [l.strip() for l in res.text.strip().split('\n') if l.strip()]
                  for line in lines:
                      parts = line.split()
                      if len(parts) >= 2 and parts[1] == "1":
                          return parts[0]
              except: pass
              return FALLBACK_VIDEO

          def hide_mouse_and_notify(driver):
              try:
                  # ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿßŸàÿ≥ ÿπÿ®ÿ± CSS
                  script = """
                  var style = document.createElement('style');
                  style.innerHTML = '* { cursor: none !important; }';
                  document.head.appendChild(style);
                  """
                  driver.execute_script(script)
              except: pass

          def start_stream(rtmp_key, sink_name, control_url, initial_delay=0):
              if initial_delay > 0:
                  time.sleep(initial_delay)
              
              width, height = 720, 1280
              os.environ['PULSE_SINK'] = sink_name
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              
              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--kiosk')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--disable-dev-shm-usage')
              opts.add_argument("--disable-notifications")
              opts.add_argument("--disable-infobars")
              
              driver = webdriver.Chrome(options=opts)
              
              # ÿ™ÿ¥ÿ∫ŸäŸÑ FFMPEG ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑ ŸÑÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ÿßŸÑÿ™ŸÇÿ∑Ÿäÿπ
              ffmpeg_cmd = [
                  'ffmpeg', '-y', '-f', 'x11grab', '-s', f'{width}x{height}', '-i', f":{disp.display}",
                  '-f', 'pulse', '-i', f"{sink_name}.monitor",
                  '-c:v', 'libx264', '-preset', 'ultrafast', '-b:v', '2500k', 
                  '-maxrate', '2500k', '-bufsize', '5000k', '-g', '60',
                  '-pix_fmt', 'yuv420p', '-c:a', 'aac', '-b:a', '128k',
                  '-f', 'flv', f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
              ]
              ffmpeg_proc = subprocess.Popen(ffmpeg_cmd)
              
              try:
                  last_url = ""
                  start_time = time.time()
                  
                  while True:
                      current_target = get_active_url(control_url)
                      
                      # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä
                      if current_target != last_url:
                          driver.get(current_target)
                          time.sleep(2)
                          hide_mouse_and_notify(driver)
                          last_url = current_target
                      
                      # ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÜÿ¥ÿßÿ∑ Ÿàÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿßŸàÿ≥ ÿØŸàÿ±ŸäÿßŸã
                      try:
                          driver.find_element(By.TAG_NAME, 'body').click()
                          hide_mouse_and_notify(driver)
                      except: pass
                      
                      # ÿ•ÿ∞ÿß ŸÖÿ± 35 ÿØŸÇŸäŸÇÿ©ÿå ŸÜÿπŸäÿØ ŸÅÿ≠ÿµ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ (ÿ£Ÿà ŸäŸÖŸÉŸÜ ÿ™ÿ±ŸÉŸáÿß ŸÑŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä ŸÅŸÇÿ∑)
                      if time.time() - start_time > SWITCH_INTERVAL:
                          start_time = time.time() # Reset timer

                      time.sleep(10) # ŸÅÿ≠ÿµ ŸÉŸÑ 10 ÿ´ŸàÿßŸÜŸç ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ∂ÿ∫ÿ∑
              finally:
                  ffmpeg_proc.terminate()
                  driver.quit()
                  disp.stop()

          if __name__ == "__main__":
              R1, R2 = os.environ.get('R1'), os.environ.get('R2')
              p1 = Process(target=start_stream, args=(R1, "Sink1", URL1_CONTROL, 0))
              p2 = Process(target=start_stream, args=(R2, "Sink2", URL2_CONTROL, 60))
              p1.start()
              p2.start()
              p1.join()
              p2.join()
          EOF

      - name: Run Streaming Script
        env:
          R1: ${{ secrets.R1 }}
          R2: ${{ secrets.R2 }}
        run: python main.py

      - name: Wait & Restart
        if: always() && !cancelled()
        run: |
          echo "‚è≥ Re-triggering..."
          sleep 300
          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart-session"}'
