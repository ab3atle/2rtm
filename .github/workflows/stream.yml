name: Perpetual Dual Stream

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable > /dev/null
          
          # ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„ØµÙˆØª ÙˆØ¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØªÙ‡
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø© (Sinks) Ù„Ø¹Ø²Ù„ Ø§Ù„ØµÙˆØª
          pactl load-module module-null-sink sink_name=Sink1
          pactl load-module module-null-sink sink_name=Sink2
          
          # ØªØ³Ù…ÙŠØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù„Ù„ØªÙ†Ø¸ÙŠÙ…
          pacmd "update-sink-proplist Sink1 device.description=Stream1_Audio"
          pacmd "update-sink-proplist Sink2 device.description=Stream2_Audio"

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os
          import subprocess
          import time
          import requests
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from multiprocessing import Process

          # --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ---
          CONTROL_URL = "https://meja.do.am/asd/url2.txt"

          def get_control_data():
              try:
                  response = requests.get(f"{CONTROL_URL}?t={int(time.time())}", timeout=5)
                  if response.status_code == 200:
                      lines = [line.strip() for line in response.text.strip().split('\n') if line.strip()]
                      results = []
                      for line in lines:
                          parts = line.split()
                          if len(parts) >= 2:
                              results.append({"url": parts[0].strip(), "status": parts[1].strip()})
                      return results
              except: pass
              return None

          def get_driver_options(width, height):
              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--disable-dev-shm-usage')
              opts.add_argument('--disable-gpu')
              opts.add_argument(f'--window-size={width},{height}')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--incognito')
              opts.add_argument('--kiosk')
              opts.add_argument('--disable-blink-features=AutomationControlled')
              opts.add_experimental_option("excludeSwitches", ["enable-automation"])
              return opts

          def start_stream(stream_id, rtmp_key, sink_name, width=720, height=1280):
              print(f"ğŸŸ¢ [Stream {stream_id}] Ø¨Ø¯Ø£Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØµÙˆØª: {sink_name}")
              
              # ÙØ±Ø¶ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ù†Ø§Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙ‚Ø·
              os.environ['PULSE_SINK'] = sink_name
              env_vars = os.environ.copy()

              # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              env_vars['DISPLAY'] = f":{disp.display}"

              driver = None
              ffmpeg_process = None
              current_url = ""

              try:
                  while True:
                      controls = get_control_data()
                      if not controls or len(controls) < stream_id:
                          time.sleep(10)
                          continue

                      config = controls[stream_id-1]
                      target_url = config['url']
                      target_status = config['status']

                      # Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
                      if target_status == "0":
                          if ffmpeg_process:
                              ffmpeg_process.terminate()
                              ffmpeg_process = None
                          if driver:
                              driver.quit()
                              driver = None
                          current_url = ""

                      # Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                      elif target_status == "1":
                          if not target_url.lower().startswith("http"):
                              time.sleep(5)
                              continue

                          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø²Ù„ Ø§Ù„ØµÙˆØª
                          if driver is None:
                              driver = webdriver.Chrome(options=get_driver_options(width, height))

                          if target_url != current_url:
                              print(f"ğŸ”„ [Stream {stream_id}] ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰: {target_url}")
                              driver.get(target_url)
                              current_url = target_url
                              time.sleep(5)
                              driver.execute_script("""
                                  var style = document.createElement('style');
                                  style.innerHTML = 'body { background: black !important; overflow: hidden !important; }';
                                  document.head.appendChild(style);
                              """)

                          # ØªØ´ØºÙŠÙ„ FFmpeg Ù„ÙŠØ³Ø­Ø¨ Ù…Ù† monitor Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø®ØµØµØ© ÙÙ‚Ø·
                          if ffmpeg_process is None:
                              print(f"ğŸ“¡ [Stream {stream_id}] ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« Ø¹Ø¨Ø± {sink_name}")
                              ffmpeg_cmd = [
                                  'ffmpeg', '-y', '-thread_queue_size', '1024',
                                  '-f', 'x11grab', '-draw_mouse', '0', '-framerate', '30',
                                  '-video_size', f'{width}x{height}', '-i', f":{disp.display}",
                                  '-f', 'pulse', '-i', f"{sink_name}.monitor",
                                  '-c:v', 'libx264', '-preset', 'ultrafast', '-b:v', '3000k',
                                  '-g', '60', '-c:a', 'aac', '-b:a', '128k', '-ar', '44100',
                                  '-f', 'flv', f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
                              ]
                              ffmpeg_process = subprocess.Popen(ffmpeg_cmd, env=env_vars)

                      time.sleep(10)
              except Exception as e:
                  print(f"âŒ [Stream {stream_id}] Error: {e}")
              finally:
                  if ffmpeg_process: ffmpeg_process.terminate()
                  if driver: driver.quit()
                  disp.stop()

          if __name__ == "__main__":
              R1 = os.environ.get('R1')
              R2 = os.environ.get('R2')
              
              if R1 and R2:
                  p1 = Process(target=start_stream, args=(1, R1, "Sink1"))
                  p2 = Process(target=start_stream, args=(2, R2, "Sink2"))
                  
                  p1.start()
                  p2.start()
                  
                  p1.join()
                  p2.join()
          EOF

      - name: Start Streaming
        env:
          R1: ${{ secrets.R1 }}
          R2: ${{ secrets.R2 }}
        run: python main.py
