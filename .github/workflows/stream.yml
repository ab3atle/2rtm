name: Perpetual Dual Stream

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable > /dev/null
          
          # ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„ØµÙˆØª Ø¨Ø¶Ø¨Ø· Ø§Ø­ØªØ±Ø§ÙÙŠ
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¯Ø§Ø®Ù„ Ø§Ù„ØµÙˆØª
          pactl load-module module-null-sink sink_name=Sink1
          pactl load-module module-null-sink sink_name=Sink2
          
          # Ø¶Ø¨Ø· Ø§Ù„Ø£ÙˆØµØ§Ù ÙˆØ§Ù„Ø®ØµØ§Ø¦Øµ
          pacmd "update-sink-proplist Sink1 device.description=Stream1"
          pacmd "update-sink-proplist Sink2 device.description=Stream2"

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os
          import subprocess
          import time
          import requests
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from multiprocessing import Process

          # --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… ---
          RUN_MINUTES = 1  # Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£ÙƒØ´Ù† ÙˆØ§Ù„Ø¨Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª
          CONTROL_URL = "https://meja.do.am/asd/url2.txt"

          def get_driver_options(width, height):
              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--disable-dev-shm-usage')
              opts.add_argument('--disable-gpu')
              opts.add_argument(f'--window-size={width},{height}')
              opts.add_argument('--window-position=0,0')
              opts.add_argument('--kiosk')
              opts.add_argument('--force-device-scale-factor=1')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--incognito')
              opts.add_argument('--disable-cache')
              opts.add_argument('--disable-blink-features=AutomationControlled')
              opts.add_experimental_option("excludeSwitches", ["enable-automation"])
              opts.add_experimental_option('useAutomationExtension', False)
              return opts

          def start_stream(stream_id, rtmp_key, sink_name, width=720, height=1280):
              print(f"ğŸŸ¢ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« {stream_id} Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø© {sink_name}")
              
              # Ø¹Ø²Ù„ Ù…Ø®Ø±Ø¬ Ø§Ù„ØµÙˆØª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙ‚Ø·
              os.environ['PULSE_SINK'] = sink_name
              env_vars = os.environ.copy()
              env_vars['PULSE_LATENCY_MSEC'] = '20'

              # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              env_vars['DISPLAY'] = f":{disp.display}"

              try:
                  # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­ÙƒÙ…
                  response = requests.get(f"{CONTROL_URL}?t={int(time.time())}", timeout=10)
                  lines = [line.strip() for line in response.text.strip().split('\n') if line.strip()]
                  
                  if len(lines) < stream_id:
                      print(f"âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¨Ø« {stream_id}")
                      return

                  config = lines[stream_id-1].split()
                  target_url = config[0]
                  status = config[1]

                  if status == "1":
                      # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­
                      driver = webdriver.Chrome(options=get_driver_options(width, height))
                      driver.get(target_url)
                      time.sleep(10) # Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„

                      # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± ÙˆØªØ·Ø¨ÙŠÙ‚ Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª)
                      driver.execute_script("""
                          var style = document.createElement('style');
                          style.innerHTML = 'body { background: black !important; overflow: hidden !important; } ::-webkit-scrollbar { display: none; }';
                          document.head.appendChild(style);
                          if(!window.moveInterval){
                              window.moveInterval = setInterval(() => { window.scrollBy(0,1); window.scrollBy(0,-1); }, 50);
                          }
                      """)

                      # Ø£Ù…Ø± FFmpeg Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª + Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«)
                      ffmpeg_cmd = [
                          'ffmpeg', '-y', '-thread_queue_size', '4096',
                          '-f', 'x11grab', '-draw_mouse', '0', '-framerate', '30',
                          '-video_size', f'{width}x{height}', '-i', f":{disp.display}",
                          '-f', 'pulse', '-thread_queue_size', '4096', '-i', f"{sink_name}.monitor",
                          '-c:v', 'libx264', '-preset', 'ultrafast', '-tune', 'zerolatency',
                          '-b:v', '3500k', '-maxrate', '3500k', '-bufsize', '7000k',
                          '-pix_fmt', 'yuv420p', '-g', '60',
                          '-c:a', 'aac', '-b:a', '128k', '-ar', '44100',
                          '-af', 'aresample=async=1', '-vsync', '1',
                          '-f', 'flv', f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
                      ]
                      
                      ffmpeg_proc = subprocess.Popen(ffmpeg_cmd, env=env_vars)
                      
                      # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                      time.sleep(RUN_MINUTES * 60)
                      
                      print(f"â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø« {stream_id} ({RUN_MINUTES} Ø¯Ù‚ÙŠÙ‚Ø©)")
                      ffmpeg_proc.terminate()
                      driver.quit()

              except Exception as e:
                  print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø« {stream_id}: {e}")
              finally:
                  disp.stop()

          if __name__ == "__main__":
              R1 = os.environ.get('R1')
              R2 = os.environ.get('R2')
              
              p1 = Process(target=start_stream, args=(1, R1, "Sink1"))
              p2 = Process(target=start_stream, args=(2, R2, "Sink2"))
              
              p1.start(); p2.start()
              
              # Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­ØªÙ‰ ØªÙ†ØªÙ‡ÙŠ (Ù…Ø¯Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)
              p1.join()
              p2.join()
              print("âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆÙØµÙ„ Ø§Ù„Ø¨Ø«ÙˆØ« Ø¨Ù†Ø¬Ø§Ø­.")
          EOF

      - name: Start Streaming
        env:
          R1: ${{ secrets.R1 }}
          R2: ${{ secrets.R2 }}
        run: python main.py
