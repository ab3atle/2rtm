name: Perpetual Single Stream 1080p 90FPS

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-session]

concurrency:
  group: streaming-group
  cancel-in-progress: true

jobs:
  stream:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§¹ Delete Old Logs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1

      - name: System Setup
        run: |
          # Ø¥Ø¬Ø¨Ø§Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… IPv4 Ù„Ù…Ù†Ø¹ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«
          sudo sh -c "echo 'Acquire::ForceIPv4 \"true\";' > /etc/apt/apt.conf.d/99force-ipv4"
          
          sudo apt-get update
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© (ÙƒØ±ÙˆÙ… Ùˆ ffmpeg Ù…ÙˆØ¬ÙˆØ¯Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„ØºØ§Ù„Ø¨)
          sudo apt-get install -y xvfb pulseaudio unclutter ffmpeg
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª Ø§Ù„ÙˆÙ‡Ù…ÙŠ
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          pactl load-module module-null-sink sink_name=Sink1

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os, subprocess, time, requests, signal
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By

          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
          URL_CONTROL = "https://meja.do.am/work/url1.txt"
          APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby8mnPnqqSqUSS9YcCJGB8UvVi3wYCYxT1uDBeTBS8C_AMlNrwLzvXb_QkHFxwYDpirPw/exec"

          def get_url_from_file(control_url):
              try:
                  res = requests.get(f"{control_url}?t={int(time.time())}", timeout=10)
                  lines = [l.strip() for l in res.text.strip().split('\n') if l.strip()]
                  for line in lines:
                      parts = line.split()
                      if len(parts) >= 2 and parts[1] == "1":
                          return parts[0]
              except Exception as e:
                  print(f"Error fetching URL: {e}")
              return None

          def run_stream():
              rtmp_key = os.environ.get('R1')
              if not rtmp_key:
                  print("No RTMP Key (R1) found!")
                  return

              # ØªÙØ¹ÙŠÙ„ Apps Script Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
              try: requests.get(APPS_SCRIPT_URL, timeout=5)
              except: pass

              # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© 1080p
              width, height = 1080, 1920
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              print(f"Display started on {disp.display}")

              # Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø§ÙˆØ³
              subprocess.Popen(['unclutter', '-idle', '0'])

              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--disable-dev-shm-usage')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--disable-gpu')
              opts.add_argument('--hide-scrollbars')
              opts.add_argument(f'--window-size={width},{height}')
              
              target_url = get_url_from_file(URL_CONTROL)
              if not target_url:
                  target_url = "about:blank"

              driver = webdriver.Chrome(options=opts)
              driver.get(target_url)
              time.sleep(10) # Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©

              # Ø¥Ø¹Ø¯Ø§Ø¯ FFmpeg Ù„Ù„Ø¨Ø« Ø¨Ø¬ÙˆØ¯Ø© 1080p Ùˆ 90 ÙØ±ÙŠÙ…
              ffmpeg_cmd = [
                  'ffmpeg', '-y',
                  '-thread_queue_size', '8192', 
                  '-f', 'x11grab',
                  '-framerate', '90',
                  '-s', f'{width}x{height}',
                  '-i', f":{disp.display}",
                  '-f', 'pulse',
                  '-i', "Sink1.monitor",
                  '-c:v', 'libx264',
                  '-preset', 'ultrafast',
                  '-tune', 'zerolatency',
                  '-b:v', '10000k', # Ø¨Øª Ø±ÙŠØª Ø¹Ø§Ù„ÙŠ Ù„Ø¯Ø¹Ù… 90 ÙØ±ÙŠÙ…
                  '-maxrate', '12000k',
                  '-bufsize', '20000k',
                  '-r', '90',
                  '-g', '180',
                  '-pix_fmt', 'yuv420p',
                  '-c:a', 'aac',
                  '-b:a', '128k',
                  '-f', 'flv',
                  f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
              ]

              ffmpeg_proc = subprocess.Popen(ffmpeg_cmd)
              print("Streaming started...")

              # Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø·
              start_time = time.time()
              last_url = target_url
              try:
                  while time.time() - start_time < 21000: # ÙŠØ¹Ù…Ù„ Ù„Ù…Ø¯Ø© 5.8 Ø³Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
                      # Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø©
                      try: driver.execute_script("window.scrollBy(0,1);")
                      except: pass
                      
                      new_url = get_url_from_file(URL_CONTROL)
                      if new_url and new_url != last_url:
                          print(f"URL Changed to: {new_url}")
                          driver.get(new_url)
                          last_url = new_url
                      
                      # Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† FFmpeg Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØ¹Ù…Ù„
                      if ffmpeg_proc.poll() is not None:
                          print("FFmpeg crashed, restarting...")
                          ffmpeg_proc = subprocess.Popen(ffmpeg_cmd)

                      time.sleep(10)
              finally:
                  ffmpeg_proc.kill()
                  driver.quit()
                  disp.stop()

          if __name__ == "__main__":
              run_stream()
          EOF

      - name: Run Streaming Script
        env:
          R1: ${{ secrets.R1 }}
        run: python main.py

      - name: Wait & Restart Workflow
        if: always()
        run: |
          sleep 30
          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart-session"}'
