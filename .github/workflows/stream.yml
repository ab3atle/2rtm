name: Perpetual Single Stream

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-session]

concurrency:
  group: streaming-group
  cancel-in-progress: true

jobs:
  stream:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§¹ Delete Old Logs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1

      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable unclutter > /dev/null
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          pactl load-module module-null-sink sink_name=Sink1

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os, subprocess, time, requests, signal
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from multiprocessing import Process

          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø«
          URL1_CONTROL = "https://meja.do.am/work/url1.txt"
          APPS_SCRIPT_URL1 = "https://script.google.com/macros/s/AKfycby8mnPnqqSqUSS9YcCJGB8UvVi3wYCYxT1uDBeTBS8C_AMlNrwLzvXb_QkHFxwYDpirPw/exec"

          def kill_all(signum, frame):
              os._exit(0)

          signal.signal(signal.SIGTERM, kill_all)
          signal.signal(signal.SIGINT, kill_all)

          def get_url_from_file(control_url):
              try:
                  res = requests.get(f"{control_url}?t={int(time.time())}", timeout=5)
                  lines = [l.strip() for l in res.text.strip().split('\n') if l.strip()]
                  for line in lines:
                      parts = line.split()
                      if len(parts) >= 2 and parts[1] == "1":
                          return parts[0]
              except:
                  pass
              return None

          def active_wait(driver, duration, control_url=None):
              start_time = time.time()
              last_url = driver.current_url
              while time.time() - start_time < duration:
                  try:
                      driver.find_element(By.TAG_NAME, 'body').click()
                  except:
                      pass
                  if control_url:
                      new_url = get_url_from_file(control_url)
                      if new_url and new_url != last_url:
                          driver.delete_all_cookies()
                          driver.execute_script("window.localStorage.clear();")
                          driver.execute_script("window.sessionStorage.clear();")
                          driver.execute_cdp_cmd('Network.clearBrowserCache', {})
                          driver.execute_cdp_cmd('Network.clearBrowserCookies', {})
                          driver.get(new_url)
                          last_url = new_url
                  time.sleep(3)

          def start_stream(rtmp_key, sink_name, control_url, apps_script_url, initial_delay=0):
              try:
                  requests.get(apps_script_url, timeout=5)
              except:
                  pass

              if initial_delay > 0:
                  time.sleep(initial_delay)
              
              width, height = 1080, 1920
              os.environ['PULSE_SINK'] = sink_name
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              subprocess.Popen(['unclutter', '-idle', '0'])
              ffmpeg_proc = None
              try:
                  target_url = get_url_from_file(control_url)
                  if target_url:
                      opts = Options()
                      opts.add_argument('--no-sandbox')
                      opts.add_argument('--disable-dev-shm-usage')
                      opts.add_argument('--autoplay-policy=no-user-gesture-required')
                      opts.add_argument('--disable-notifications')
                      opts.add_argument('--disable-infobars')
                      opts.add_argument('--disable-extensions')
                      opts.add_argument('--disable-popup-blocking')
                      opts.add_argument('--disable-features=TranslateUI')
                      opts.add_argument('--disable-gpu')
                      opts.add_experimental_option("excludeSwitches", ["enable-automation"])
                      opts.add_experimental_option('useAutomationExtension', False)
                      opts.add_argument('--disable-blink-features=AutomationControlled')
                      opts.add_argument('--hide-scrollbars')
                      opts.add_argument(f'--app={target_url}')

                      driver = webdriver.Chrome(options=opts)
                      time.sleep(8)

                      ffmpeg_cmd = [
                          'ffmpeg', '-y',
                          '-thread_queue_size', '1024', # ØªÙ‚Ù„ÙŠÙ„ Ø®Ø·Ø± Ø³Ù‚ÙˆØ· Ø§Ù„ÙØ±ÙŠÙ…Ø§Øª
                          '-f', 'x11grab',
                          '-framerate', '90',          # Ø§Ù„ØªÙ‚Ø§Ø· 90 ÙØ±ÙŠÙ… Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
                          '-s', f'{width}x{height}',
                          '-i', f":{disp.display}",
                          '-f', 'pulse',
                          '-i', f"{sink_name}.monitor",
                          '-c:v', 'libx264',
                          '-preset', 'ultrafast',     # Ø£Ø³Ø±Ø¹ Ø£Ø¯Ø§Ø¡ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬
                          '-tune', 'zerolatency',     # Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ«Ø¨Ø§Øª Ø§Ù„Ø¨Ø«
                          '-b:v', '6000k',             # Ø±ÙØ¹ Ø§Ù„Ø¨Øª Ø±ÙŠØª Ù„ÙŠØ¯Ø¹Ù… 1080p Ø¨Ù€ 90 ÙØ±ÙŠÙ…
                          '-maxrate', '6000k',
                          '-bufsize', '12000k',
                          '-r', '90',                  # Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø« Ø¨Ù€ 90 ÙØ±ÙŠÙ… Ø«Ø§Ø¨ØªØ©
                          '-g', '180',                 # keyframe interval (2 seconds for 90fps)
                          '-keyint_min', '180',
                          '-sc_threshold', '0',
                          '-pix_fmt', 'yuv420p',
                          '-c:a', 'aac',
                          '-b:a', '128k',
                          '-f', 'flv',
                          f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
                      ]

                      ffmpeg_proc = subprocess.Popen(ffmpeg_cmd)
                      active_wait(driver, 13000, control_url)
              finally:
                  if ffmpeg_proc:
                      ffmpeg_proc.kill()
                  try:
                      driver.quit()
                  except:
                      pass
                  disp.stop()

          if __name__ == "__main__":
              R1 = os.environ.get('R1')
              p1 = Process(target=start_stream, args=(R1, "Sink1", URL1_CONTROL, APPS_SCRIPT_URL1, 0))
              p1.start()
              p1.join()
          EOF

      - name: Run Streaming Script
        env:
          R1: ${{ secrets.R1 }}
        run: python main.py

      - name: Wait & Restart
        if: always()
        run: |
          python - <<'PYTHON'
          import time, signal, sys
          stop = False
          def handler(signum, frame):
              global stop
              stop = True
          signal.signal(signal.SIGTERM, handler)
          signal.signal(signal.SIGINT, handler)
          wait_seconds = 5
          for _ in range(0, wait_seconds):
              if stop: sys.exit(0)
              time.sleep(1)
          PYTHON

          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart-session"}'
