name: Perpetual Dual Stream

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-session]

jobs:
  stream:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write # Ù‚Ù…Øª Ø¨ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ù€ write Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙØ¹Ù„Ù‡Ø§
      
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ§¹ Delete Old Logs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 2

      - name: System Setup
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq xvfb ffmpeg pulseaudio google-chrome-stable > /dev/null
          pulseaudio -D --exit-idle-time=-1 --disallow-exit || true
          pactl load-module module-null-sink sink_name=Sink1
          pactl load-module module-null-sink sink_name=Sink2
          pacmd "update-sink-proplist Sink1 device.description=Stream1"
          pacmd "update-sink-proplist Sink2 device.description=Stream2"

      - name: Python Setup
        run: pip install selenium pyvirtualdisplay requests

      - name: Create Python Script
        run: |
          cat << 'EOF' > main.py
          import os, subprocess, time, requests
          from pyvirtualdisplay import Display
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from multiprocessing import Process

          RUN_MINUTES = 5 
          CONTROL_URL = "https://meja.do.am/asd/url2.txt"

          def get_driver_options(width, height):
              opts = Options()
              opts.add_argument('--no-sandbox')
              opts.add_argument('--disable-dev-shm-usage')
              opts.add_argument('--disable-gpu')
              opts.add_argument(f'--window-size={width},{height}')
              opts.add_argument('--kiosk')
              opts.add_argument('--autoplay-policy=no-user-gesture-required')
              opts.add_argument('--incognito')
              return opts

          def start_stream(stream_id, rtmp_key, sink_name, width=720, height=1280):
              os.environ['PULSE_SINK'] = sink_name
              env_vars = os.environ.copy()
              disp = Display(visible=0, size=(width, height), backend='xvfb')
              disp.start()
              env_vars['DISPLAY'] = f":{disp.display}"
              try:
                  response = requests.get(f"{CONTROL_URL}?t={int(time.time())}", timeout=10)
                  lines = [line.strip() for line in response.text.strip().split('\n') if line.strip()]
                  if len(lines) < stream_id: return
                  config = lines[stream_id-1].split()
                  if config[1] == "1":
                      driver = webdriver.Chrome(options=get_driver_options(width, height))
                      driver.get(config[0])
                      time.sleep(10)
                      driver.execute_script("document.body.style.overflow = 'hidden';")
                      ffmpeg_cmd = [
                          'ffmpeg', '-y', '-f', 'x11grab', '-s', f'{width}x{height}', '-i', f":{disp.display}",
                          '-f', 'pulse', '-i', f"{sink_name}.monitor",
                          '-c:v', 'libx264', '-preset', 'ultrafast', '-b:v', '3500k',
                          '-f', 'flv', f"rtmp://a.rtmp.youtube.com/live2/{rtmp_key}"
                      ]
                      proc = subprocess.Popen(ffmpeg_cmd, env=env_vars)
                      time.sleep(RUN_MINUTES * 300)
                      proc.terminate()
                      driver.quit()
              finally:
                  disp.stop()

          if __name__ == "__main__":
              R1, R2 = os.environ.get('R1'), os.environ.get('R2')
              if R1 and R2:
                  p1 = Process(target=start_stream, args=(1, R1, "Sink1"))
                  p2 = Process(target=start_stream, args=(2, R2, "Sink2"))
                  p1.start(); p2.start()
                  p1.join(); p2.join()
          EOF

      - name: Run Streaming Script
        env:
          R1: ${{ secrets.R1 }}
          R2: ${{ secrets.R2 }}
        run: python main.py

      - name: Wait & Restart
        if: always()
        run: |
          echo "â³ Ø§Ø³ØªØ±Ø§Ø­Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©..."
          sleep 60
          # ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ Ù„ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙŠØ¨Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø©
          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart-session"}'
